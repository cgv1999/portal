// ============================================
// ВСТРОЕННЫЕ ДАННЫЕ - ВАШ JSON КОНТЕНТ
// ============================================
// Вставьте сюда ваш JSON с данными
const embeddedData = {
    "mainData": [
        {
            "Дата": "10.11.2025",
            "Объект": "Козубенко Денис",
            "Адрес": "ДМИТРОВСКОЕ",
            "Выручка": 91368,
            "Выручка Сайт": 0,
            "Автохимия Шампунь Москва": -3306.548571,
            "Автохимия Шампунь СПБ": 0,
            "Автохимия Пена": -971.4285714,
            "Автохимия Юр. Лица": 0,
            "Автохимия Абонементы/сертификаты/подписки": 0,
            "Коммунальные расходы": -6395.76,
            "Коммунальные расходы Абонементы/сертификаты/подписки": 0,
            "Аренда": -2138.304,
            "Зарплата": -12726.97211,
            "Комиссии": -2101.464,
            "Налоги": -5482.08,
            "НДС": -4350.857143,
            "Прочие": 0,
            "Неделимый расход": -25183.65719,
            "Франшиза сопровождение бонус": 0,
            "Операционная прибыль": 28710.92842
        },
        {
            "Дата": "10.11.2025",
            "Объект": "Козубенко Денис",
            "Адрес": "ПЯТНИЦКОЕ",
            "Выручка": 74118,
            "Выручка Сайт": 0,
            "Автохимия Шампунь Москва": -3306.548571,
            "Автохимия Шампунь СПБ": 0,
            "Автохимия Пена": -914.1428571,
            "Автохимия Юр. Лица": 0,
            "Автохимия Абонементы/сертификаты/подписки": 0,
            "Коммунальные расходы": -5188.26,
            "Коммунальные расходы Абонементы/сертификаты/подписки": 0,
            "Аренда": -2744.156667,
            "Зарплата": -12726.97211,
            "Комиссии": -1704.714,
            "Налоги": -2964.72,
            "НДС": -4848.841121,
            "Прочие": 0,
            "Неделимый расход": -25183.65719,
            "Франшиза сопровождение бонус": 0,
            "Операционная прибыль": 14535.98749
        },
        {
            "Дата": "10.11.2025",
            "Объект": "Козубенко Денис",
            "Адрес": "Пятницкое шоссе 20",
            "Выручка": 34108.2,
            "Выручка Сайт": 0,
            "Автохимия Шампунь Москва": -3600,
            "Автохимия Шампунь СПБ": 0,
            "Автохимия Пена": -428.4285714,
            "Автохимия Юр. Лица": 0,
            "Автохимия Абонементы/сертификаты/подписки": 0,
            "Коммунальные расходы": -2387.574,
            "Коммунальные расходы Абонементы/сертификаты/подписки": 0,
            "Аренда": 0,
            "Зарплата": -12726.97211,
            "Комиссии": -784.4886,
            "Налоги": -1364.328,
            "НДС": -1624.2,
            "Прочие": 0,
            "Неделимый расход": -25183.65719,
            "Франшиза сопровождение бонус": 0,
            "Операционная прибыль": -13991.44847
        },
        {
            "Дата": "10.11.2025",
            "Объект": "Козубенко Денис",
            "Адрес": "ХИМКИ",
            "Выручка": 64010,
            "Выручка Сайт": 0,
            "Автохимия Шампунь Москва": -4959.822857,
            "Автохимия Шампунь СПБ": 0,
            "Автохимия Пена": -1185.642857,
            "Автохимия Юр. Лица": 0,
            "Автохимия Абонементы/сертификаты/подписки": 0,
            "Коммунальные расходы": -4480.7,
            "Коммунальные расходы Абонементы/сертификаты/подписки": 0,
            "Аренда": 0,
            "Зарплата": -13393.63877,
            "Комиссии": -1472.23,
            "Налоги": -3840.6,
            "НДС": -3048.095238,
            "Прочие": 0,
            "Неделимый расход": -25183.65719,
            "Франшиза сопровождение бонус": 0,
            "Операционная прибыль": 6445.613086
        },
        // ... добавьте остальные данные mainData
    ],
    "expensesData": [
        {
            "сумма": -456820.2,
            "статья": "Nan",
            "наименование": "Nan",
            "мойка": "Общий расход",
            "команда": "",
            "дата": "06.01.2025",
            "ответственный": "Nan"
        },
        {
            "сумма": -456820.2,
            "статья": "Nan",
            "наименование": "Nan",
            "мойка": "Общий расход",
            "команда": "Розница",
            "дата": "06.01.2025",
            "ответственный": "Nan"
        },
        // ... добавьте остальные данные expensesData
    ],
    "salaryData": [
        {
            "неделя": "01.09.25 - 07.09.25",
            "сотрудник": "Абрамов Никита Олегович",
            "должность": "Программист- разработчик ",
            "подразделение": "",
            "исходные_данные": {
                "итого": 180000,
                "оф_зп": 75038,
                "коэффициент": 0.43
            },
            "файл_источник": "01.09.25 - 07.09.25.csv"
        },
        {
            "неделя": "01.09.25 - 07.09.25",
            "сотрудник": "Агапеева Евгения Алексеевна",
            "должность": "Ассистент руководителя Николаева Антона",
            "подразделение": "",
            "исходные_данные": {
                "итого": 40000,
                "оф_зп": 30100,
                "коэффициент": 0.43
            },
            "файл_источник": "01.09.25 - 07.09.25.csv"
        },
        {
            "неделя": "31.03.25 - 06.04.25",
            "сотрудник": "Nan",
            "должность": "Nan",
            "подразделение": "",
            "исходные_данные": {
                "итого": 0,
                "оф_зп": 13517441.86,
                "коэффициент": 0.43
            },
            "файл_источник": "31.03.25 - 06.04.25.csv"
        },
        // ... добавьте остальные данные salaryData
    ]
};

// Глобальные переменные
let allData = [];
let otherExpensesData = [];
let salaryOfficeData = [];
let currentSortField = 'сумма';
let currentSortDirection = 'desc';
let currentIndivisibleSortField = 'сумма';
let currentIndivisibleSortDirection = 'desc';
let currentGeneralExpenseSortField = 'сумма';
let currentGeneralExpenseSortDirection = 'desc';
let currentSalaryOfficeSortField = 'зарплата';
let currentSalaryOfficeSortDirection = 'desc';
let currentChart = null;
let allWeeks = [];

// Определяем объекты розницы
const retailObjects = [
    "Козубенко Денис",
    "Сенатов Кирилл",
    "Большаков Максим",
    "Мозговой Филипп",
    "Данилов Алексей",
    "Ичко Роман",
    "Юрлов Денис"
];

const addressMapping = {
    "Каспийская": "Каспийская",
    "ТТК": "ТТК",
    "ттк": "ТТК",
    "Шереметьевская РН": "ШЕРЕМЕТЬЕВСКАЯ",
    "ВДНХ РН": "ВДНХ",
    "Дмитровка РН": "ДМИТРОВСКОЕ",
    "Профсоюзная РН": "ПРОФСОЮЗНАЯ",
    "профсоюзная РН": "ПРОФСОЮЗНАЯ",
    "Новоясеневский ВР": "НОВОЯСЕНЕВСКИЙ",
    "Мытищи ЭКА": "МЫТИЩИ",
    "Лобачевского, 37 ВР": "ЛОБАЧЕВСКОГО 37",
    "Химки": "ХИМКИ",
    "химки": "ХИМКИ",
    "ПЯТНИЦКОЕ Ш. 27": "ПЯТНИЦКОЕ",
    "Загородное ВР": "ЗАГОРОДНОЕ",
    "Пятницкое шоссе 20": "Пятницкое шоссе 20",
    "Привольная ВР": "ПРИВОЛЬНАЯ",
    "Мичуринский ВР": "МИЧУРИНСКИЙ",
    "Рублевка, 4 ВР": "РУБЛЕВСКОЕ вл.4",
    "Рублевка, 4 РН": "РУБЛЕВСКОЕ вл.4",
    "Вернадского РН": "ВЕРНАДСКОГО",
    "Рублевское ш., д. 91а ВР": "РУБЛЕВКА91",
    "Лобачевского,92А ВР": "ЛОБАЧЕВСКОГО 92",
    "Плещеева ВР": "ПЛЕЩЕЕВА",
    "Паперника ВР": "ПАПЕРНИКА вл.22",
    "Люблинская ВР": "ЛЮБЛИНСКАЯ 135",
    "Проспект мира 94": "Пр Мира 94 А",
    "Проспект Мира 94": "Пр Мира 94 А",
    "Коломенский пр-д": "Коломенский пр-д",
    "Правобережная": "ПРАВОБЕРЕЖНАЯ",
    "Носовихинское": "Носовихинское",
    "Куликовская": "Куликовская",
    "Чертановская": "Чертановская",
    "Минская": "Минская",
    "СПБ Маршала Жукова": "СПб, Маршала Жукова",
    "Франшиза отдел продаж": "Франшиза отдел продаж",
    "франшиза отдел продаж": "Франшиза отдел продаж",
    "Франшиза отдел сопровождения": "Франшиза отдел сопровождения",
    "франшиза отдел сопровождения": "Франшиза отдел сопровождения",
    "Угрешская 5": "Дзержинский, Угрешская",
    "Каширское 24": "КАШИРСКОЕ 24",
    "Развитие": "Развитие",
    "Франшиза": "Франшиза отдел продаж",
    "Общий расход": "Общий расход"
};

// Функция для автоматической загрузки данных при старте
function loadEmbeddedData() {
    try {
        // Загружаем данные из embeddedData
        allData = embeddedData.mainData || [];
        otherExpensesData = embeddedData.expensesData || [];
        salaryOfficeData = embeddedData.salaryData || [];

        // ОБРАБОТКА ЗАРПЛАТ: парсим период из названия файла если нет в данных
        salaryOfficeData = processSalaryData(salaryOfficeData);

        // Обновляем интерфейс
        const totalRecords = allData.length + otherExpensesData.length + salaryOfficeData.length;

        // Заполняем фильтры и применяем
        if (allData.length > 0) {
            populateFilters(allData);
            applyFilters();
        }

    } catch (error) {
        console.error('Ошибка загрузки данных:', error);
    }
}

// НОВАЯ ФУНКЦИЯ: Обработка данных зарплат
function processSalaryData(salaryData) {
    if (!salaryData) return [];

    return salaryData.map(item => {
        // Исправляем "Nan" на пустую строку
        const employeeName = (item.сотрудник === "Nan" || item.сотрудник === "NaN") ? "" : item.сотрудник;
        const position = (item.должность === "Nan" || item.должность === "NaN") ? "" : item.должность;

        // Исправляем формат недели (добавляем 20 для годов)
        let weekStr = item.неделя || "Неизвестная неделя";
        weekStr = weekStr.replace(/(\d{2})\.(\d{2})\.(\d{2})/g, function (match, day, month, year) {
            const fullYear = year.length === 2 ? `20${year}` : year;
            return `${day}.${month}.${fullYear}`;
        });

        // Получаем месяц и год из недели
        const monthInfo = getPredominantMonthForWeek(weekStr);

        return {
            ...item,
            сотрудник: employeeName,
            должность: position,
            неделя: weekStr,
            месяц: monthInfo.month,
            год: monthInfo.year,
            дней_в_месяце: monthInfo.daysInMonth
        };
    });
}

// Вспомогательные функции
function getDaysInMonth(month, year) {
    const monthMap = {
        'Январь': 31,
        'Февраль': (year % 4 === 0 && (year % 100 !== 0 || year % 400 === 0)) ? 29 : 28,
        'Март': 31,
        'Апрель': 30,
        'Май': 31,
        'Июнь': 30,
        'Июль': 31,
        'Август': 31,
        'Сентябрь': 30,
        'Октябрь': 31,
        'Ноябрь': 30,
        'Декабрь': 31
    };
    return monthMap[month] || 30;
}

function getPredominantMonthForWeek(weekStr) {
    if (!weekStr) return { month: 'Октябрь', year: 2025, daysInMonth: 31 };
    try {
        const parts = weekStr.split(' - ');
        if (parts.length !== 2) return { month: 'Октябрь', year: 2025, daysInMonth: 31 };

        const startDate = new Date(parts[0].trim().split('.').reverse().join('-'));
        const endDate = new Date(parts[1].trim().split('.').reverse().join('-'));

        const monthDays = {};
        let currentDate = new Date(startDate);

        while (currentDate <= endDate) {
            const month = currentDate.toLocaleString('ru-RU', { month: 'long' });
            const capitalizedMonth = month.charAt(0).toUpperCase() + month.slice(1);
            const year = currentDate.getFullYear();
            const key = `${capitalizedMonth}_${year}`;
            monthDays[key] = (monthDays[key] || 0) + 1;
            currentDate.setDate(currentDate.getDate() + 1);
        }

        let maxDays = 0;
        let predominantMonthKey = '';
        for (const [key, days] of Object.entries(monthDays)) {
            if (days > maxDays) {
                maxDays = days;
                predominantMonthKey = key;
            }
        }

        if (predominantMonthKey) {
            const [month, year] = predominantMonthKey.split('_');
            const daysInMonth = getDaysInMonth(month, parseInt(year));
            return {
                month: month,
                year: parseInt(year),
                daysInMonth: daysInMonth,
                daysInWeek: maxDays
            };
        }
    } catch (e) {
        console.error('Ошибка определения месяца для недели:', weekStr, e);
    }
    return { month: 'Октябрь', year: 2025, daysInMonth: 31 };
}

function extractWeekFromFileName(fileName) {
    if (!fileName) return 'Неизвестная неделя';

    const patterns = [
        /(\d{2}\.\d{2}\.\d{2})\s*-\s*(\d{2}\.\d{2}\.\d{2})/,
        /(\d{2}\.\d{2}\.\d{4})\s*-\s*(\d{2}\.\d{2}\.\d{4})/,
        /(\d{2}-\d{2}-\d{4})\s*-\s*(\d{2}-\d{2}-\d{4})/,
    ];

    for (const pattern of patterns) {
        const match = fileName.match(pattern);
        if (match) {
            const weekPart1 = match[1].replace(/-/g, '.');
            const weekPart2 = match[2].replace(/-/g, '.');

            // Форматируем даты в стандартный вид ДД.ММ.ГГГГ
            const formatDatePart = (datePart) => {
                const parts = datePart.split('.');
                if (parts.length === 3) {
                    const day = parts[0].padStart(2, '0');
                    const month = parts[1].padStart(2, '0');
                    let year = parts[2];
                    if (year.length === 2) {
                        year = '20' + year;
                    }
                    return `${day}.${month}.${year}`;
                }
                return datePart;
            };

            return `${formatDatePart(weekPart1)} - ${formatDatePart(weekPart2)}`;
        }
    }
    return 'Неизвестная неделя';
}

function calculateSalaryForPeriod() {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    if (!dateFrom || !dateTo) return 0;

    const fromDate = new Date(dateFrom);
    const toDate = new Date(dateTo);
    const diffTime = Math.abs(toDate - fromDate);
    const daysInPeriod = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

    let totalSalaryExpense = 0;
    let processedWeeks = new Set();
    const weeklyData = {};

    salaryOfficeData.forEach(item => {
        if (!item.неделя) return;
        if (!weeklyData[item.неделя]) {
            weeklyData[item.неделя] = {
                сотрудники: [],
                месяц: item.месяц,
                год: item.год,
                дней_в_месяце: item.дней_в_месяце
            };
        }
        weeklyData[item.неделя].сотрудники.push(item);
    });

    for (const [weekStr, weekData] of Object.entries(weeklyData)) {
        try {
            const weekParts = weekStr.split(' - ');
            if (weekParts.length !== 2) continue;

            const weekStart = new Date(weekParts[0].trim().split('.').reverse().join('-'));
            const weekEnd = new Date(weekParts[1].trim().split('.').reverse().join('-'));

            const weekInPeriod = (weekStart >= fromDate && weekStart <= toDate) ||
                (weekEnd >= fromDate && weekEnd <= toDate) ||
                (weekStart <= fromDate && weekEnd >= toDate);

            if (weekInPeriod) {
                processedWeeks.add(weekStr);
                const weekStartInPeriod = weekStart < fromDate ? fromDate : weekStart;
                const weekEndInPeriod = weekEnd > toDate ? toDate : weekEnd;
                const weekDaysInPeriod = Math.ceil((weekEndInPeriod - weekStartInPeriod) / (1000 * 60 * 60 * 24)) + 1;

                weekData.сотрудники.forEach(item => {
                    const totalAmount = item.исходные_данные?.итого || 0;
                    const officeSalary = item.исходные_данные?.оф_зп || 0;
                    const coefficient = item.исходные_данные?.коэффициент || 0;
                    const daysInMonth = item.дней_в_месяце || weekData.дней_в_месяце || 30;
                    const dailySalary = -((totalAmount + (officeSalary * coefficient)) / daysInMonth);
                    const salaryForWeekDays = dailySalary * weekDaysInPeriod;
                    totalSalaryExpense += salaryForWeekDays;
                });
            }
        } catch (e) {
            console.error('Ошибка обработки недели:', weekStr, e);
        }
    }

    return totalSalaryExpense;
}

function getGeneralExpenseForDateRange() {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    if (!dateFrom || !dateTo) return 0;

    const fromDate = new Date(dateFrom);
    const toDate = new Date(dateTo);

    const generalExpenses = otherExpensesData.filter(expense => {
        if (expense.мойка !== "Общий расход") return false;
        if (expense.команда && expense.команда.trim() !== '') return false;
        const expenseDate = new Date(expense.дата.split('.').reverse().join('-'));
        return expenseDate >= fromDate && expenseDate <= toDate;
    });

    return generalExpenses.reduce((sum, expense) => sum + expense.сумма, 0);
}

function getIndivisibleExpenseForDateRange(selectedObject, selectedAddresses) {
    if (!allData.length && !otherExpensesData.length) return 0;

    const isDrilldownMode = (!selectedObject || selectedObject === 'all_retail') &&
        (!selectedAddresses || selectedAddresses.length === 0);

    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;

    if (isDrilldownMode) {
        const indivisibleExpenses = otherExpensesData.filter(expense => {
            const isIndivisible = expense.мойка === "Общий расход" &&
                expense.команда &&
                String(expense.команда).toLowerCase() === 'розница';
            if (!isIndivisible) return false;
            if (dateFrom && dateTo) {
                const expenseDate = new Date(expense.дата.split('.').reverse().join('-'));
                const fromDate = new Date(dateFrom);
                const toDate = new Date(dateTo);
                if (expenseDate < fromDate || expenseDate > toDate) return false;
            }
            return true;
        });
        return indivisibleExpenses.reduce((sum, expense) => sum + expense.сумма, 0);
    } else {
        let totalIndivisible = 0;
        let filteredData = allData;

        if (dateFrom && dateTo) {
            filteredData = allData.filter(row => {
                const rowDateStr = row.Дата;
                if (!rowDateStr) return true;
                try {
                    const rowDate = new Date(rowDateStr.split('.').reverse().join('-'));
                    const fromDate = new Date(dateFrom);
                    const toDate = new Date(dateTo);
                    return rowDate >= fromDate && rowDate <= toDate;
                } catch (e) {
                    return true;
                }
            });
        }

        filteredData = filteredData.filter(row => {
            const rowObject = row.Объект;
            const rowAddress = row.Адрес;

            if (selectedObject) {
                if (selectedObject === 'all_retail') {
                    if (!retailObjects.includes(rowObject)) return false;
                } else if (rowObject !== selectedObject) {
                    return false;
                }
            }

            if (selectedAddresses && selectedAddresses.length > 0) {
                if (!selectedAddresses.includes(rowAddress)) return false;
            }

            return true;
        });

        filteredData.forEach(row => {
            for (const key in row) {
                if (key.toLowerCase().includes('неделимый') || key === 'Неделимый расход') {
                    totalIndivisible += parseFloat(row[key]) || 0;
                    break;
                }
            }
        });

        return totalIndivisible;
    }
}

function getFilteredIndivisibleExpenses() {
    const selectedObject = getSelectedObject();
    const selectedAddresses = getSelectedAddresses();
    const isDrilldownMode = (!selectedObject || selectedObject === 'all_retail') &&
        (!selectedAddresses || selectedAddresses.length === 0);

    if (!isDrilldownMode) return [];

    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;

    return otherExpensesData.filter(expense => {
        const isIndivisible = expense.мойка === "Общий расход" &&
            expense.команда &&
            String(expense.команда).toLowerCase() === 'розница';
        if (!isIndivisible) return false;
        if (dateFrom && dateTo) {
            const expenseDate = new Date(expense.дата.split('.').reverse().join('-'));
            const fromDate = new Date(dateFrom);
            const toDate = new Date(dateTo);
            if (expenseDate < fromDate || expenseDate > toDate) return false;
        }
        return true;
    });
}

function getFilteredGeneralExpenseExpenses() {
    const selectedObject = getSelectedObject();
    const selectedAddresses = getSelectedAddresses();
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;

    return otherExpensesData.filter(expense => {
        if (expense.мойка !== "Общий расход") return false;
        if (expense.команда && expense.команда.trim() !== '') return false;
        if (dateFrom && dateTo) {
            const expenseDate = new Date(expense.дата.split('.').reverse().join('-'));
            const fromDate = new Date(dateFrom);
            const toDate = new Date(dateTo);
            if (expenseDate < fromDate || expenseDate > toDate) return false;
        }
        if (selectedObject) {
            if (selectedObject === 'all_retail') {
                if (!retailObjects.includes(expense.объект)) return false;
            } else if (expense.объект !== selectedObject) {
                return false;
            }
        }
        if (selectedAddresses && !selectedAddresses.includes(expense.мойка)) {
            return false;
        }
        return true;
    });
}

function getFilteredSalaryOfficeExpenses() {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    if (!dateFrom || !dateTo) return [];

    const fromDate = new Date(dateFrom);
    const toDate = new Date(dateTo);
    const diffTime = Math.abs(toDate - fromDate);
    const daysInPeriod = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

    const result = [];
    let processedWeeks = new Set();
    const weeklyData = {};

    salaryOfficeData.forEach(item => {
        if (!item.неделя) return;
        if (!weeklyData[item.неделя]) {
            weeklyData[item.неделя] = {
                сотрудники: [],
                месяц: item.месяц,
                год: item.год,
                дней_в_месяце: item.дней_в_месяце
            };
        }
        weeklyData[item.неделя].сотрудники.push(item);
    });

    for (const [weekStr, weekData] of Object.entries(weeklyData)) {
        try {
            const weekParts = weekStr.split(' - ');
            if (weekParts.length !== 2) continue;

            const weekStart = new Date(weekParts[0].trim().split('.').reverse().join('-'));
            const weekEnd = new Date(weekParts[1].trim().split('.').reverse().join('-'));

            const weekInPeriod = (weekStart >= fromDate && weekStart <= toDate) ||
                (weekEnd >= fromDate && weekEnd <= toDate) ||
                (weekStart <= fromDate && weekEnd >= toDate);

            if (weekInPeriod) {
                processedWeeks.add(weekStr);
                const weekStartInPeriod = weekStart < fromDate ? fromDate : weekStart;
                const weekEndInPeriod = weekEnd > toDate ? toDate : weekEnd;
                const weekDaysInPeriod = Math.ceil((weekEndInPeriod - weekStartInPeriod) / (1000 * 60 * 60 * 24)) + 1;

                weekData.сотрудники.forEach(item => {
                    const totalAmount = item.исходные_данные?.итого || 0;
                    const officeSalary = item.исходные_данные?.оф_зп || 0;
                    const coefficient = item.исходные_данные?.коэффициент || 0;
                    const daysInMonth = item.дней_в_месяце || weekData.дней_в_месяце || 30;
                    const dailySalary = (totalAmount + (officeSalary * coefficient)) / daysInMonth;
                    const salaryForWeekDays = dailySalary * weekDaysInPeriod;

                    result.push({
                        неделя: weekStr,
                        дней_в_неделе: weekDaysInPeriod,
                        сотрудник: item.сотрудник,
                        должность: item.должность,
                        зарплата: salaryForWeekDays,
                        исходные_данные: {
                            итого: totalAmount,
                            оф_зп: officeSalary,
                            коэффициент: coefficient,
                            дней_в_месяце: daysInMonth,
                            дневная_зарплата: dailySalary
                        },
                        файл_источник: item.файл_источник
                    });
                });
            }
        } catch (e) {
            console.error('Ошибка обработки недели:', weekStr, e);
        }
    }

    return result;
}

function sortExpensesData(data, field, direction) {
    return [...data].sort((a, b) => {
        let aValue = a[field];
        let bValue = b[field];

        if (field === 'сумма') {
            aValue = Math.abs(aValue);
            bValue = Math.abs(bValue);
        }

        if (field === 'дата') {
            aValue = new Date(aValue.split('.').reverse().join('-'));
            bValue = new Date(bValue.split('.').reverse().join('-'));
        }

        if (typeof aValue === 'string') {
            aValue = aValue.toLowerCase();
            bValue = bValue.toLowerCase();
        }

        if (direction === 'asc') {
            return aValue > bValue ? 1 : aValue < bValue ? -1 : 0;
        } else {
            return aValue < bValue ? 1 : aValue > bValue ? -1 : 0;
        }
    });
}

function sortSalaryOfficeData(data, field, direction) {
    return [...data].sort((a, b) => {
        let aValue = a[field];
        let bValue = b[field];

        if (field === 'зарплата') {
            aValue = Math.abs(aValue);
            bValue = Math.abs(bValue);
        }

        if (typeof aValue === 'string') {
            aValue = aValue.toLowerCase();
            bValue = bValue.toLowerCase();
        }

        if (direction === 'asc') {
            return aValue > bValue ? 1 : aValue < bValue ? -1 : 0;
        } else {
            return aValue < bValue ? 1 : aValue > bValue ? -1 : 0;
        }
    });
}

function updateExpensesTable(filteredExpenses) {
    const sortedData = sortExpensesData(filteredExpenses, currentSortField, currentSortDirection);
    const expensesDetails = document.getElementById('expensesDetails');

    if (sortedData.length === 0) {
        expensesDetails.innerHTML = '<div class="loading">Нет данных по прочим расходам для выбранных фильтров</div>';
        return;
    }

    let tableHtml = `
        <table class="expenses-table">
            <thead>
                <tr>
                    <th class="${currentSortField === 'сумма' ? (currentSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeSort('сумма')">Сумма</th>
                    <th class="${currentSortField === 'статья' ? (currentSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeSort('статья')">Статья</th>
                    <th class="${currentSortField === 'наименование' ? (currentSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeSort('наименование')">Наименование</th>
                    <th class="${currentSortField === 'мойка' ? (currentSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeSort('мойка')">Мойка</th>
                    <th class="${currentSortField === 'команда' ? (currentSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeSort('команда')">Команда</th>
                    <th class="${currentSortField === 'дата' ? (currentSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeSort('дата')">Дата оплаты</th>
                </tr>
            </thead>
            <tbody>
    `;

    sortedData.forEach(expense => {
        tableHtml += `
            <tr>
                <td>${formatCurrency(expense.сумма)}</td>
                <td>${expense.статья}</td>
                <td>${expense.наименование}</td>
                <td>${expense.мойка}</td>
                <td>${expense.команда || ''}</td>
                <td>${expense.дата}</td>
            </tr>
        `;
    });

    const total = sortedData.reduce((sum, item) => sum + item.сумма, 0);
    tableHtml += `
            </tbody>
        </table>
        <div style="margin-top: 15px; font-weight: bold;">
            Итого: ${formatCurrency(total)} (${sortedData.length} записей)
        </div>
    `;

    expensesDetails.innerHTML = tableHtml;
    updateSortInfo();
}

function updateIndivisibleTable(filteredExpenses) {
    const sortedData = sortExpensesData(filteredExpenses, currentIndivisibleSortField, currentIndivisibleSortDirection);
    const indivisibleDetails = document.getElementById('indivisibleDetails');

    if (sortedData.length === 0) {
        indivisibleDetails.innerHTML = '<div class="loading">Нет данных по неделимому расходу для выбранных фильтров</div>';
        return;
    }

    let tableHtml = `
        <table class="expenses-table">
            <thead>
                <tr>
                    <th class="${currentIndivisibleSortField === 'сумма' ? (currentIndivisibleSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeIndivisibleSort('сумма')">Сумма</th>
                    <th class="${currentIndivisibleSortField === 'статья' ? (currentIndivisibleSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeIndivisibleSort('статья')">Статья</th>
                    <th class="${currentIndivisibleSortField === 'наименование' ? (currentIndivisibleSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeIndivisibleSort('наименование')">Наименование</th>
                    <th class="${currentIndivisibleSortField === 'мойка' ? (currentIndivisibleSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeIndivisibleSort('мойка')">Мойка</th>
                    <th class="${currentIndivisibleSortField === 'команда' ? (currentIndivisibleSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeIndivisibleSort('команда')">Команда</th>
                    <th class="${currentIndivisibleSortField === 'дата' ? (currentIndivisibleSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeIndivisibleSort('дата')">Дата оплаты</th>
                </tr>
            </thead>
            <tbody>
    `;

    sortedData.forEach(expense => {
        tableHtml += `
            <tr>
                <td>${formatCurrency(expense.сумма)}</td>
                <td>${expense.статья}</td>
                <td>${expense.наименование}</td>
                <td>${expense.мойка}</td>
                <td>${expense.команда || ''}</td>
                <td>${expense.дата}</td>
            </tr>
        `;
    });

    const total = sortedData.reduce((sum, item) => sum + item.сумма, 0);
    tableHtml += `
            </tbody>
        </table>
        <div style="margin-top: 15px; font-weight: bold;">
            Итого: ${formatCurrency(total)} (${sortedData.length} записей)
        </div>
    `;

    indivisibleDetails.innerHTML = tableHtml;
    updateIndivisibleSortInfo();
}

function updateGeneralExpenseTable(filteredExpenses) {
    const sortedData = sortExpensesData(filteredExpenses, currentGeneralExpenseSortField, currentGeneralExpenseSortDirection);
    const generalExpenseDetails = document.getElementById('generalExpenseDetails');

    if (sortedData.length === 0) {
        generalExpenseDetails.innerHTML = '<div class="loading">Нет данных по общему расходу для выбранных фильтров</div>';
        return;
    }

    let tableHtml = `
        <table class="expenses-table">
            <thead>
                <tr>
                    <th class="${currentGeneralExpenseSortField === 'сумма' ? (currentGeneralExpenseSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeGeneralExpenseSort('сумма')">Сумма</th>
                    <th class="${currentGeneralExpenseSortField === 'статья' ? (currentGeneralExpenseSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeGeneralExpenseSort('статья')">Статья</th>
                    <th class="${currentGeneralExpenseSortField === 'наименование' ? (currentGeneralExpenseSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeGeneralExpenseSort('наименование')">Наименование</th>
                    <th class="${currentGeneralExpenseSortField === 'мойка' ? (currentGeneralExpenseSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeGeneralExpenseSort('мойка')">Мойка</th>
                    <th class="${currentGeneralExpenseSortField === 'команда' ? (currentGeneralExpenseSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeGeneralExpenseSort('команда')">Команда</th>
                    <th class="${currentGeneralExpenseSortField === 'дата' ? (currentGeneralExpenseSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeGeneralExpenseSort('дата')">Дата оплаты</th>
                </tr>
            </thead>
            <tbody>
    `;

    sortedData.forEach(expense => {
        tableHtml += `
            <tr>
                <td>${formatCurrency(expense.сумма)}</td>
                <td>${expense.статья}</td>
                <td>${expense.наименование}</td>
                <td>${expense.мойка}</td>
                <td>${expense.команда || ''}</td>
                <td>${expense.дата}</td>
            </tr>
        `;
    });

    const total = sortedData.reduce((sum, item) => sum + item.сумма, 0);
    tableHtml += `
            </tbody>
        </table>
        <div style="margin-top: 15px; font-weight: bold;">
            Итого: ${formatCurrency(total)} (${sortedData.length} записей)
        </div>
    `;

    generalExpenseDetails.innerHTML = tableHtml;
    updateGeneralExpenseSortInfo();
}

function updateSalaryOfficeTable(filteredExpenses) {
    const sortedData = sortSalaryOfficeData(filteredExpenses, currentSalaryOfficeSortField, currentSalaryOfficeSortDirection);
    const salaryOfficeDetails = document.getElementById('salaryOfficeDetails');

    if (sortedData.length === 0) {
        salaryOfficeDetails.innerHTML = `
            <div class="loading">
                Нет данных по З/п офис для выбранного периода<br>
                Всего записей в базе: ${salaryOfficeData.length}
            </div>
        `;
        return;
    }

    let tableHtml = `
        <table class="expenses-table">
            <thead>
                <tr>
                    <th class="${currentSalaryOfficeSortField === 'сотрудник' ? (currentSalaryOfficeSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeSalaryOfficeSort('сотрудник')">Сотрудник</th>
                    <th class="${currentSalaryOfficeSortField === 'должность' ? (currentSalaryOfficeSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeSalaryOfficeSort('должность')">Должность</th>
                    <th class="${currentSalaryOfficeSortField === 'зарплата' ? (currentSalaryOfficeSortDirection === 'desc' ? 'sorted-desc' : 'sorted-asc') : ''}" onclick="changeSalaryOfficeSort('зарплата')">Зарплата за период</th>
                    <th>Неделя</th>
                    <th>Дней в неделе</th>
                    <th>Детали расчета</th>
                </tr>
            </thead>
            <tbody>
    `;

    sortedData.forEach(expense => {
        const details = `Дневная: ${formatCurrency(expense.исходные_данные.дневная_зарплата)} = (${formatCurrency(expense.исходные_данные.итого)} + ${formatCurrency(expense.исходные_данные.оф_зп)} × ${expense.исходные_данные.коэффициент}) / ${expense.исходные_данные.дней_в_месяце} дней`;

        tableHtml += `
            <tr>
                <td>${expense.сотрудник || 'Не указан'}</td>
                <td>${expense.должность || 'Не указана'}</td>
                <td>${formatCurrency(expense.зарплата)}</td>
                <td>${expense.неделя}</td>
                <td>${expense.дней_в_неделе}</td>
                <td title="${details}">${details.length > 60 ? details.substring(0, 60) + '...' : details}</td>
            </tr>
        `;
    });

    const totalЗарплата = sortedData.reduce((sum, item) => sum + item.зарплата, 0);
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    const diffTime = Math.abs(new Date(dateTo) - new Date(dateFrom));
    const daysInPeriod = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

    tableHtml += `
            </tbody>
        </table>
        <div style="margin-top: 15px; font-weight: bold;">
            Итого сотрудников: ${sortedData.length}<br>
            Сумма зарплат за период: ${formatCurrency(totalЗарплата)}<br>
            Период: ${dateFrom} - ${dateTo} (${daysInPeriod} дней)
        </div>
    `;

    salaryOfficeDetails.innerHTML = tableHtml;
    updateSalaryOfficeSortInfo();
}

function changeSort(field) {
    if (currentSortField === field) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortField = field;
        currentSortDirection = field === 'сумма' ? 'desc' : 'asc';
    }
    const filteredExpenses = getFilteredOtherExpenses();
    updateExpensesTable(filteredExpenses);
    updateSortButtons();
}

function changeIndivisibleSort(field) {
    if (currentIndivisibleSortField === field) {
        currentIndivisibleSortDirection = currentIndivisibleSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentIndivisibleSortField = field;
        currentIndivisibleSortDirection = field === 'сумма' ? 'desc' : 'asc';
    }
    const filteredExpenses = getFilteredIndivisibleExpenses();
    updateIndivisibleTable(filteredExpenses);
    updateIndivisibleSortButtons();
}

function changeGeneralExpenseSort(field) {
    if (currentGeneralExpenseSortField === field) {
        currentGeneralExpenseSortDirection = currentGeneralExpenseSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentGeneralExpenseSortField = field;
        currentGeneralExpenseSortDirection = field === 'сумма' ? 'desc' : 'asc';
    }
    const filteredExpenses = getFilteredGeneralExpenseExpenses();
    updateGeneralExpenseTable(filteredExpenses);
    updateGeneralExpenseSortButtons();
}

function changeSalaryOfficeSort(field) {
    if (currentSalaryOfficeSortField === field) {
        currentSalaryOfficeSortDirection = currentSalaryOfficeSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSalaryOfficeSortField = field;
        currentSalaryOfficeSortDirection = field === 'зарплата' ? 'desc' : 'asc';
    }
    const filteredExpenses = getFilteredSalaryOfficeExpenses();
    updateSalaryOfficeTable(filteredExpenses);
    updateSalaryOfficeSortButtons();
}

function showExpensesDetails() {
    const modal = document.getElementById('expensesModal');
    const modalTitle = document.getElementById('modalTitle');

    const selectedObject = getSelectedObject();
    const selectedAddresses = getSelectedAddresses();
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;

    let title = 'Детализация расходов "Прочие" (исключая "Общий расход")';
    if (dateFrom && dateTo) title += ` | Период: ${dateFrom} - ${dateTo}`;
    if (selectedObject) title += ` | ${selectedObject === 'all_retail' ? 'Вся розница' : selectedObject}`;
    if (selectedAddresses) title += ` | Адресов: ${selectedAddresses.length}`;

    modalTitle.textContent = title;
    const filteredExpenses = getFilteredOtherExpenses();
    updateSortButtons();
    updateExpensesTable(filteredExpenses);
    modal.style.display = 'block';
}

function showIndivisibleDetails() {
    const modal = document.getElementById('indivisibleModal');
    const modalTitle = document.getElementById('indivisibleModalTitle');

    const selectedObject = getSelectedObject();
    const selectedAddresses = getSelectedAddresses();
    const isDrilldownMode = (!selectedObject || selectedObject === 'all_retail') &&
        (!selectedAddresses || selectedAddresses.length === 0);

    if (!isDrilldownMode) {
        alert('Детализация "Неделимый расход" доступна только в режиме дриллдауна (Все объекты/Вся розница + Все адреса)');
        return;
    }

    let title = 'Детализация расходов "Неделимый расход" (Мойка = "Общий расход", Команда = "Розница")';
    if (selectedObject) title += ` | ${selectedObject === 'all_retail' ? 'Вся розница' : selectedObject}`;
    if (selectedAddresses) title += ` | Адресов: ${selectedAddresses.length}`;

    modalTitle.textContent = title;
    const filteredExpenses = getFilteredIndivisibleExpenses();
    updateIndivisibleSortButtons();
    updateIndivisibleTable(filteredExpenses);
    modal.style.display = 'block';
}

function showGeneralExpenseDetails() {
    const modal = document.getElementById('generalExpenseModal');
    const modalTitle = document.getElementById('generalExpenseModalTitle');

    const selectedObject = getSelectedObject();
    const selectedAddresses = getSelectedAddresses();

    let title = 'Детализация расходов "Общий расход" (Мойка = "Общий расход", Команда = "")';
    if (selectedObject) title += ` | ${selectedObject === 'all_retail' ? 'Вся розница' : selectedObject}`;
    if (selectedAddresses) title += ` | Адресов: ${selectedAddresses.length}`;

    modalTitle.textContent = title;
    const filteredExpenses = getFilteredGeneralExpenseExpenses();
    updateGeneralExpenseSortButtons();
    updateGeneralExpenseTable(filteredExpenses);
    modal.style.display = 'block';
}

function showSalaryOfficeDetails() {
    const modal = document.getElementById('salaryOfficeModal');
    const modalTitle = document.getElementById('salaryOfficeModalTitle');

    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;

    let title = 'Детализация расходов "З/п офис" - Сотрудники';
    if (dateFrom && dateTo) {
        title += ` | Период: ${dateFrom} - ${dateTo}`;
    }

    modalTitle.textContent = title;
    const filteredExpenses = getFilteredSalaryOfficeExpenses();
    updateSalaryOfficeSortButtons();
    updateSalaryOfficeTable(filteredExpenses);
    modal.style.display = 'block';
}

function getFilteredOtherExpenses() {
    const selectedObject = getSelectedObject();
    const selectedAddresses = getSelectedAddresses();
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;

    return otherExpensesData.filter(expense => {
        if (expense.мойка === "Общий расход") {
            return false;
        }
        if (dateFrom && dateTo) {
            const expenseDate = new Date(expense.дата.split('.').reverse().join('-'));
            const fromDate = new Date(dateFrom);
            const toDate = new Date(dateTo);
            if (expenseDate < fromDate || expenseDate > toDate) return false;
        }
        if (selectedObject) {
            if (selectedObject === 'all_retail') {
                if (!retailObjects.includes(expense.объект)) {
                    return false;
                }
            } else if (expense.объект !== selectedObject) {
                return false;
            }
        }
        if (selectedAddresses && !selectedAddresses.includes(expense.мойка)) {
            return false;
        }
        return true;
    });
}

function populateFilters(data) {
    // Отфильтровываем строки с "Франшиза роялти" в адресе
    const filteredData = data.filter(row => {
        const address = String(row.Адрес || '').trim();
        return !address.toLowerCase().includes('франшиза роялти');
    });

    allWeeks = [...new Set(filteredData.map(row => row.Неделя || row['﻿Неделя']))].filter(Boolean);
    allWeeks.sort((a, b) => {
        const dateA = new Date(a.split(' - ')[0].split('.').reverse().join('-'));
        const dateB = new Date(b.split(' - ')[0].split('.').reverse().join('-'));
        return dateA - dateB;
    });

    const objects = [...new Set(filteredData.map(row => row.Объект))]
        .filter(Boolean)
        .filter(obj => obj !== "Продажа объекта/агентские");

    const addresses = [...new Set(filteredData.map(row => row.Адрес))]
        .filter(Boolean)
        .filter(address => {
            const addr = String(address).trim();
            return !addr.toLowerCase().includes('франшиза роялти');
        });

    const objectsSelect = document.getElementById('objectSelect');
    objectsSelect.innerHTML = '<option value="">Все объекты</option>';

    const allRetailOption = document.createElement('option');
    allRetailOption.value = 'all_retail';
    allRetailOption.textContent = 'Вся розница';
    objectsSelect.appendChild(allRetailOption);

    const orderedObjects = [];
    const retailOrder = [
        "Козубенко Денис",
        "Сенатов Кирилл",
        "Большаков Максим",
        "Мозговой Филипп",
        "Данилов Алексей",
        "Ичко Роман",
        "Юрлов Денис"
    ];

    retailOrder.forEach(retailObj => {
        if (objects.includes(retailObj)) {
            orderedObjects.push(retailObj);
        }
    });

    const specialObjects = [
        "Юр. Лица",
        "Абонементы/сертификаты",
        "Подписка на мойку",
        "Франшиза отдел продаж",
        "Развитие",
        "Франшиза отдел сопровождения"
    ];

    specialObjects.forEach(specialObj => {
        if (objects.includes(specialObj)) {
            orderedObjects.push(specialObj);
        }
    });

    const remainingObjects = objects.filter(obj =>
        ![...retailOrder, ...specialObjects].includes(obj)
    );

    remainingObjects.sort((a, b) => a.localeCompare(b));
    orderedObjects.push(...remainingObjects);

    orderedObjects.forEach(object => {
        const option = document.createElement('option');
        option.value = object;
        option.textContent = object;
        objectsSelect.appendChild(option);
    });

    const addressSelect = document.getElementById('addressSelect');
    addressSelect.innerHTML = '<option value="">Все адреса</option>';
    addresses.forEach(address => {
        const option = document.createElement('option');
        option.value = address;
        option.textContent = address;
        addressSelect.appendChild(option);
    });

    document.getElementById('filters').style.display = 'flex';

    objectsSelect.addEventListener('change', function () {
        updateAddressFilter(this.value, data);
        applyFilters();
    });

    addressSelect.addEventListener('change', function () {
        updateSelectedInfo('addressSelected', this);
        applyFilters();
    });

    updateSelectedInfo('addressSelected', addressSelect);

    // АВТОМАТИЧЕСКОЕ ОПРЕДЕЛЕНИЕ ДАТ
    const dateTo = document.getElementById('dateTo');
    const dateFrom = document.getElementById('dateFrom');

    // Если есть данные для определения дат
    if (filteredData.length > 0 || salaryOfficeData.length > 0) {
        let minDate = null;
        let maxDate = null;

        // 1. Ищем даты в основных данных
        filteredData.forEach(row => {
            if (row.Дата) {
                try {
                    const rowDate = new Date(row.Дата.split('.').reverse().join('-'));
                    if (!minDate || rowDate < minDate) minDate = rowDate;
                    if (!maxDate || rowDate > maxDate) maxDate = rowDate;
                } catch (e) {
                    // Игнорируем ошибки парсинга
                }
            }
        });

        // 2. Ищем даты в зарплатных данных (из поля неделя)
        salaryOfficeData.forEach(item => {
            if (item.неделя) {
                try {
                    const weekParts = item.неделя.split(' - ');
                    if (weekParts.length === 2) {
                        const weekStart = new Date(weekParts[0].trim().split('.').reverse().join('-'));
                        const weekEnd = new Date(weekParts[1].trim().split('.').reverse().join('-'));

                        if (!minDate || weekStart < minDate) minDate = weekStart;
                        if (!maxDate || weekEnd > maxDate) maxDate = weekEnd;
                    }
                } catch (e) {
                    // Игнорируем ошибки парсинга
                }
            }
        });

        // 3. Устанавливаем даты по умолчанию
        if (minDate && maxDate) {
            // Устанавливаем последний месяц по умолчанию
            const endDate = new Date(maxDate);
            const startDate = new Date(maxDate);
            startDate.setMonth(startDate.getMonth() - 1); // За последний месяц

            // Форматируем даты для input type="date"
            dateTo.value = endDate.toISOString().split('T')[0];
            dateFrom.value = startDate.toISOString().split('T')[0];
        } else {
            // Если не нашли дат, ставим текущий месяц
            const today = new Date();
            dateTo.valueAsDate = today;
            const monthAgo = new Date();
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            dateFrom.valueAsDate = monthAgo;
        }
    } else {
        // Если нет данных, ставим текущий месяц
        const today = new Date();
        dateTo.valueAsDate = today;
        const monthAgo = new Date();
        monthAgo.setMonth(monthAgo.getMonth() - 1);
        dateFrom.valueAsDate = monthAgo;
    }
}

function updateSelectedInfo(containerId, selectElement) {
    const selectedOptions = Array.from(selectElement.selectedOptions)
        .map(option => option.value)
        .filter(value => value && value !== '');

    const container = document.getElementById(containerId);
    if (selectedOptions.length > 0) {
        container.textContent = `Выбрано: ${selectedOptions.length}`;
        container.title = selectedOptions.join(', ');
    } else {
        container.textContent = 'Все';
        container.title = '';
    }
}

function updateAddressFilter(selectedObject, data) {
    const addressSelect = document.getElementById('addressSelect');
    const currentSelected = Array.from(addressSelect.selectedOptions).map(opt => opt.value);

    let filteredAddresses;

    if (selectedObject === 'all_retail') {
        filteredAddresses = [...new Set(data
            .filter(row => retailObjects.includes(row.Объект))
            .map(row => row.Адрес))].filter(Boolean);
    } else if (selectedObject) {
        filteredAddresses = [...new Set(data
            .filter(row => row.Объект === selectedObject)
            .map(row => row.Адрес))].filter(Boolean);
    } else {
        filteredAddresses = [...new Set(data.map(row => row.Адрес))].filter(Boolean);
    }

    addressSelect.innerHTML = '<option value="">Все адреса</option>';
    filteredAddresses.forEach(address => {
        const option = document.createElement('option');
        option.value = address;
        option.textContent = address;
        if (currentSelected.includes(address)) {
            option.selected = true;
        }
        addressSelect.appendChild(option);
    });

    updateSelectedInfo('addressSelected', addressSelect);
}

function getSelectedObject() {
    const objectSelect = document.getElementById('objectSelect');
    return objectSelect.value !== '' ? objectSelect.value : null;
}

function getSelectedAddresses() {
    const addressSelect = document.getElementById('addressSelect');
    const selectedAddresses = Array.from(addressSelect.selectedOptions)
        .map(option => option.value)
        .filter(value => value && value !== '');
    return selectedAddresses.length > 0 ? selectedAddresses : null;
}

function applyFilters() {
    const selectedObject = getSelectedObject();
    const selectedAddresses = getSelectedAddresses();

    // Отфильтровываем строки с "Франшиза роялти" в адресе
    let filteredData = allData.filter(row => {
        const address = String(row.Адрес || '').trim();
        return !address.toLowerCase().includes('франшиза роялти');
    });

    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;

    if (dateFrom && dateTo) {
        filteredData = filteredData.filter(row => {
            const rowDateStr = row.Дата;
            if (!rowDateStr) return true;
            try {
                const rowDate = new Date(rowDateStr.split('.').reverse().join('-'));
                const fromDate = new Date(dateFrom);
                const toDate = new Date(dateTo);
                return rowDate >= fromDate && rowDate <= toDate;
            } catch (e) {
                return true;
            }
        });
    }

    if (selectedObject) {
        if (selectedObject === 'all_retail') {
            filteredData = filteredData.filter(row => retailObjects.includes(row.Объект));
        } else {
            filteredData = filteredData.filter(row => row.Объект === selectedObject);
        }
    }

    if (selectedAddresses) {
        filteredData = filteredData.filter(row => selectedAddresses.includes(row.Адрес));
    }

    updateSelectionInfo(dateFrom, dateTo, selectedObject, selectedAddresses, filteredData.length);

    if (filteredData.length > 0) {
        buildChart(filteredData, selectedObject, selectedAddresses);
    } else {
        document.getElementById('chart').innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">Нет данных для выбранных фильтров</div>';
    }
}

function updateSelectionInfo(dateFrom, dateTo, object, addresses, count) {
    let info = `Показано записей: ${count}`;
    if (dateFrom && dateTo) {
        info += ` | Период: ${dateFrom} - ${dateTo}`;
    }
    if (object) {
        info += ` | Объект: ${object === 'all_retail' ? 'Вся розница' : object}`;
    }
    if (addresses) {
        info += ` | Адресов: ${addresses.length}`;
    }
    document.getElementById('fileInfo').textContent = info;
}

function buildChart(data, object, addresses) {
    if (currentChart) {
        currentChart.dispose();
        currentChart = null;
    }

    const chart = echarts.init(document.getElementById('chart'));
    currentChart = chart;

    const aggregated = aggregateCategories(data);

    let categories = [
        "Выручка",
        "Автохимия",
        "Коммунальные расходы",
        "Аренда",
        "Зарплата",
        "Комиссии",
        "Налоги",
        "НДС",
        "Прочие",
        "Неделимый расход",
        "Операционная прибыль"
    ];

    const selectedObject = getSelectedObject();
    const selectedAddresses = getSelectedAddresses();

    let showFranchBonus = false;
    const isAllObjectsAllAddresses = (!selectedObject || selectedObject === '') &&
        (!selectedAddresses || selectedAddresses.length === 0);
    const isFranchObject = selectedObject === 'Франшиза отдел сопровождения';
    showFranchBonus = isAllObjectsAllAddresses || isFranchObject;

    if (showFranchBonus) {
        const profitIndex = categories.indexOf("Операционная прибыль");
        categories.splice(profitIndex, 0, "Франшиза сопровождение бонус");
    }

    const isAllObjects = !object || object === '';
    const isAllAddresses = !addresses || addresses.length === 0;
    const showCompanyExpenses = isAllObjects && isAllAddresses;

    if (showCompanyExpenses) {
        let insertIndex;
        if (showFranchBonus) {
            insertIndex = categories.indexOf("Франшиза сопровождение бонус");
        } else {
            insertIndex = categories.indexOf("Операционная прибыль");
        }
        categories.splice(insertIndex, 0, "Общий расход", "З/п офис");
    }

    const values = categories.map(cat => {
        switch (cat) {
            case "Выручка":
                return (aggregated['Выручка'] || 0) + (aggregated['Выручка Сайт'] || 0);
            case "Автохимия":
                return -Math.abs(
                    (aggregated['Автохимия Шампунь Москва'] || 0) +
                    (aggregated['Автохимия Шампунь СПБ'] || 0) +
                    (aggregated['Автохимия Пена'] || 0) +
                    (aggregated['Автохимия Юр. Лица'] || 0) +
                    (aggregated['Автохимия Абонементы/сертификаты/подписки'] || 0)
                );
            case "Коммунальные расходы":
                return -Math.abs(
                    (aggregated['Коммунальные расходы'] || 0) +
                    (aggregated['Коммунальные расходы Абонементы/сертификаты/подписки'] || 0)
                );
            case "Аренда":
                return -Math.abs(aggregated['Аренда'] || 0);
            case "Зарплата":
                return -Math.abs(aggregated['Зарплата'] || 0);
            case "Комиссии":
                return -Math.abs(aggregated['Комиссии'] || 0);
            case "Налоги":
                return -Math.abs(aggregated['Налоги'] || 0);
            case "НДС":
                return -Math.abs(aggregated['НДС'] || 0);
            case "Прочие":
                const filteredOtherExpenses = getFilteredOtherExpenses();
                return filteredOtherExpenses.reduce((sum, item) => sum + item.сумма, 0);
            case "Неделимый расход":
                return getIndivisibleExpenseForDateRange(object, addresses);
            case "Общий расход":
                if (showCompanyExpenses) {
                    return getGeneralExpenseForDateRange();
                }
                return 0;
            case "З/п офис":
                if (showCompanyExpenses) {
                    return calculateSalaryForPeriod();
                }
                return 0;
            case "Франшиза сопровождение бонус":
                const franchBonus = aggregated['Франшиза сопровождение бонус'] ||
                    aggregated['Франшиза сопровождение бонус:'] || 0;
                return Math.abs(franchBonus);
            case "Операционная прибыль":
                return 0;
            default:
                return 0;
        }
    });

    const waterfallData = [];
    let currentLevel = 0;

    values.forEach((value, index) => {
        const category = categories[index];

        if (category === "Выручка") {
            waterfallData.push({ value: value, start: 0, end: value });
            currentLevel = value;
        } else if (category === "Операционная прибыль") {
            waterfallData.push({ value: currentLevel, start: 0, end: currentLevel });
        } else if (category === "Франшиза сопровождение бонус") {
            const start = currentLevel;
            currentLevel += value;
            waterfallData.push({ value: value, start: start, end: currentLevel });
        } else {
            const start = currentLevel;
            currentLevel += value;
            waterfallData.push({ value: value, start: start, end: currentLevel });
        }
    });

    renderChart(chart, categories, waterfallData, object, addresses, showCompanyExpenses, showFranchBonus, currentLevel);
}

function aggregateCategories(data) {
    const aggregated = {};
    data.forEach(row => {
        for (const key in row) {
            if (key !== 'Неделя' && key !== '﻿Неделя' && key !== 'Объект' && key !== 'Адрес' && key !== 'Дата') {
                if (!aggregated[key]) aggregated[key] = 0;
                aggregated[key] += row[key] || 0;
            }
        }
    });
    return aggregated;
}

function formatCurrency(value) {
    if (value === 0) return '0';
    const absValue = Math.abs(value);
    if (absValue >= 1000000) {
        return (value / 1000000).toFixed(1) + 'M';
    } else if (absValue >= 1000) {
        return (value / 1000).toFixed(0) + 'k';
    }
    return Math.round(value).toLocaleString('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

function renderChart(chart, categories, waterfallData, object, addresses, showCompanyExpenses, showFranchBonus, finalProfit) {
    const revenueIndex = categories.indexOf("Выручка");
    const franchBonusIndex = showFranchBonus ? categories.indexOf("Франшиза сопровождение бонус") : -1;
    const profitIndex = categories.indexOf("Операционная прибыль");

    const revenue = waterfallData[revenueIndex].value;
    const franchBonus = franchBonusIndex !== -1 ? waterfallData[franchBonusIndex].value : 0;
    const profit = finalProfit;
    const totalRevenue = revenue + franchBonus;
    const profitability = totalRevenue !== 0 ? (profit / totalRevenue) * 100 : -100;

    let titleText = 'Каскадная диаграмма - Финансовый анализ';
    let subtitle = `Рентабельность: ${profitability.toFixed(1)}%`;

    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    if (dateFrom && dateTo) {
        subtitle += ` | Период: ${dateFrom} - ${dateTo}`;
    }
    if (object) {
        subtitle += ` | ${object === 'all_retail' ? 'Вся розница' : object}`;
    }
    if (addresses) {
        subtitle += ` | Адресов: ${addresses.length}`;
    }

    const seriesData = waterfallData.map((item, index) => {
        const category = categories[index];
        const isPositive = item.value >= 0;
        const isProfit = category === "Операционная прибыль";

        let color;
        if (isProfit) {
            color = item.value >= 0 ? '#28a745' : '#dc3545';
        } else if (category === "Франшиза сопровождение бонус") {
            color = '#4CAF50';
        } else {
            color = isPositive ? '#4CAF50' : '#F44336';
        }

        const itemStyle = { color: color };
        const selectedObject = getSelectedObject();
        const selectedAddresses = getSelectedAddresses();
        const isDrilldownMode = (!selectedObject || selectedObject === 'all_retail') &&
            (!selectedAddresses || selectedAddresses.length === 0);

        if (category === "Прочие" || category === "Общий расход" || category === "З/п офис") {
            itemStyle.cursor = 'pointer';
        } else if (category === "Неделимый расход") {
            if (isDrilldownMode) {
                itemStyle.cursor = 'pointer';
            } else {
                itemStyle.cursor = 'default';
            }
        } else if (category === "Франшиза сопровождение бонус") {
            itemStyle.cursor = 'default';
        }

        return {
            value: item.value,
            itemStyle: itemStyle
        };
    });

    const option = {
        title: {
            text: titleText,
            subtext: subtitle,
            left: 'center',
            textStyle: {
                fontSize: 16,
                fontWeight: 'bold'
            }
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            },
            formatter: function (params) {
                const tar = params[0];
                const value = tar.value;
                const category = categories[tar.dataIndex];
                let tooltip = `
                    <div style="text-align: left">
                        <strong>${category}</strong><br/>
                        Значение: ${formatCurrency(value)}
                `;

                const selectedObject = getSelectedObject();
                const selectedAddresses = getSelectedAddresses();
                const isDrilldownMode = (!selectedObject || selectedObject === 'all_retail') &&
                    (!selectedAddresses || selectedAddresses.length === 0);

                if (category === "Прочие") {
                    const filteredExpenses = getFilteredOtherExpenses();
                    tooltip += `<br/><em>Кликните для детализации (${filteredExpenses.length} записей)</em>`;
                } else if (category === "Неделимый расход") {
                    if (isDrilldownMode) {
                        const filteredExpenses = getFilteredIndivisibleExpenses();
                        tooltip += `<br/><em>Кликните для детализации (${filteredExpenses.length} записей)</em>`;
                    } else {
                        tooltip += `<br/><em>Данные из P&L (детализация доступна в режиме дриллдауна)</em>`;
                    }
                } else if (category === "Общий расход") {
                    const filteredExpenses = getFilteredGeneralExpenseExpenses();
                    tooltip += `<br/><em>Кликните для детализации (${filteredExpenses.length} записей)</em>`;
                } else if (category === "З/п офис") {
                    const filteredExpenses = getFilteredSalaryOfficeExpenses();
                    tooltip += `<br/><em>Кликните для детализации сотрудников (${filteredExpenses.length} записей)</em>`;
                } else if (category === "Франшиза сопровождение бонус") {
                    tooltip += `<br/><em>Выручка от франшизы сопровождения (добавляется после расходов)</em>`;
                }

                tooltip += `</div>`;
                return tooltip;
            }
        },
        legend: {
            show: false
        },
        grid: {
            left: '5%',
            right: '5%',
            bottom: '15%',
            top: '15%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: categories,
            axisLabel: {
                interval: 0,
                rotate: 45,
                fontSize: 11,
                margin: 10
            },
            axisTick: {
                alignWithLabel: true
            }
        },
        yAxis: {
            type: 'value',
            scale: true,
            axisLabel: {
                formatter: formatCurrency
            }
        },
        series: [
            {
                name: 'Финансовый поток',
                type: 'bar',
                barWidth: '60%',
                itemStyle: {
                    borderColor: '#fff',
                    borderWidth: 2
                },
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                },
                label: {
                    show: true,
                    position: 'inside',
                    formatter: function (params) {
                        return formatCurrency(params.value);
                    },
                    fontSize: 10,
                    color: '#fff',
                    fontWeight: 'bold'
                },
                data: seriesData
            }
        ]
    };

    chart.setOption(option);

    chart.on('click', function (params) {
        if (params.componentType === 'series' && params.seriesType === 'bar') {
            const category = categories[params.dataIndex];
            const selectedObject = getSelectedObject();
            const selectedAddresses = getSelectedAddresses();
            const isDrilldownMode = (!selectedObject || selectedObject === 'all_retail') &&
                (!selectedAddresses || selectedAddresses.length === 0);

            if (category === "Прочие") {
                showExpensesDetails();
            } else if (category === "Неделимый расход") {
                if (isDrilldownMode) {
                    showIndivisibleDetails();
                } else {
                    alert('Детализация "Неделимый расход" доступна только в режиме дриллдауна (Все объекты/Вся розница + Все адреса)');
                }
            } else if (category === "Общий расход") {
                showGeneralExpenseDetails();
            } else if (category === "З/п офис") {
                showSalaryOfficeDetails();
            }
        }
    });

    updateStats(revenue, franchBonus, profit, profitability, showFranchBonus);

    window.addEventListener('resize', function () {
        chart.resize();
    });
}

function updateStats(revenue, franchBonus, profit, profitability, showFranchBonus) {
    let statsHtml = `
        <div class="stat-item">Выручка: ${formatCurrency(revenue)}</div>
    `;

    if (showFranchBonus) {
        statsHtml += `
            <div class="stat-item" style="background-color: #4CAF50;">Франшиза бонус: ${formatCurrency(franchBonus)}</div>
        `;
    }

    const totalRevenue = revenue + franchBonus;

    if (showFranchBonus) {
        statsHtml += `
            <div class="stat-item" style="background-color: #ffc107;">Общая выручка: ${formatCurrency(totalRevenue)}</div>
        `;
    }

    statsHtml += `
        <div class="stat-item ${profit >= 0 ? 'positive' : 'negative'}">Прибыль: ${formatCurrency(profit)}</div>
        <div class="stat-item ${profitability >= 0 ? 'positive' : 'negative'}">Рентабельность: ${profitability.toFixed(1)}%</div>
    `;

    document.getElementById('statsInfo').innerHTML = statsHtml;
}

function updateSortInfo() {
    const sortInfo = document.getElementById('sortInfo');
    const fieldNames = {
        'сумма': 'сумме',
        'статья': 'статье',
        'наименование': 'наименованию',
        'мойка': 'мойке',
        'команда': 'команде',
        'дата': 'дате'
    };
    const directionNames = {
        'asc': 'по возрастанию',
        'desc': 'по убыванию'
    };
    sortInfo.textContent = `Отсортировано по ${fieldNames[currentSortField]} (${directionNames[currentSortDirection]})`;
}

function updateSortButtons() {
    const sortByAmount = document.getElementById('sortByAmount');
    const sortByDate = document.getElementById('sortByDate');
    const sortByArticle = document.getElementById('sortByArticle');

    sortByAmount.textContent = 'Сортировать по сумме';
    sortByDate.textContent = 'Сортировать по дате';
    sortByArticle.textContent = 'Сортировать по статье';

    if (currentSortField === 'сумма') {
        sortByAmount.textContent = `Сумма ${currentSortDirection === 'desc' ? '▼' : '▲'}`;
    } else if (currentSortField === 'дата') {
        sortByDate.textContent = `Дата ${currentSortDirection === 'desc' ? '▼' : '▲'}`;
    } else if (currentSortField === 'статья') {
        sortByArticle.textContent = `Статья ${currentSortDirection === 'desc' ? '▼' : '▲'}`;
    }
}

function updateIndivisibleSortInfo() {
    const sortInfo = document.getElementById('indivisibleSortInfo');
    const fieldNames = {
        'сумма': 'сумме',
        'статья': 'статье',
        'наименование': 'наименованию',
        'мойка': 'мойке',
        'команда': 'команде',
        'дата': 'дате'
    };
    const directionNames = {
        'asc': 'по возрастанию',
        'desc': 'по убыванию'
    };
    sortInfo.textContent = `Отсортировано по ${fieldNames[currentIndivisibleSortField]} (${directionNames[currentIndivisibleSortDirection]})`;
}

function updateGeneralExpenseSortInfo() {
    const sortInfo = document.getElementById('generalExpenseSortInfo');
    const fieldNames = {
        'сумма': 'сумме',
        'статья': 'статье',
        'наименование': 'наименованию',
        'мойка': 'мойке',
        'команда': 'команде',
        'дата': 'дате'
    };
    const directionNames = {
        'asc': 'по возрастанию',
        'desc': 'по убыванию'
    };
    sortInfo.textContent = `Отсортировано по ${fieldNames[currentGeneralExpenseSortField]} (${directionNames[currentGeneralExpenseSortDirection]})`;
}

function updateSalaryOfficeSortInfo() {
    const sortInfo = document.getElementById('salaryOfficeSortInfo');
    const fieldNames = {
        'сотрудник': 'сотруднику',
        'должность': 'должности',
        'зарплата': 'зарплате'
    };
    const directionNames = {
        'asc': 'по возрастанию',
        'desc': 'по убыванию'
    };
    sortInfo.textContent = `Отсортировано по ${fieldNames[currentSalaryOfficeSortField]} (${directionNames[currentSalaryOfficeSortDirection]})`;
}

function updateIndivisibleSortButtons() {
    const sortByAmount = document.getElementById('indivisibleSortByAmount');
    const sortByDate = document.getElementById('indivisibleSortByDate');
    const sortByArticle = document.getElementById('indivisibleSortByArticle');

    sortByAmount.textContent = 'Сортировать по сумме';
    sortByDate.textContent = 'Сортировать по дате';
    sortByArticle.textContent = 'Сортировать по статье';

    if (currentIndivisibleSortField === 'сумма') {
        sortByAmount.textContent = `Сумма ${currentIndivisibleSortDirection === 'desc' ? '▼' : '▲'}`;
    } else if (currentIndivisibleSortField === 'дата') {
        sortByDate.textContent = `Дата ${currentIndivisibleSortDirection === 'desc' ? '▼' : '▲'}`;
    } else if (currentIndivisibleSortField === 'статья') {
        sortByArticle.textContent = `Статья ${currentIndivisibleSortDirection === 'desc' ? '▼' : '▲'}`;
    }
}

function updateGeneralExpenseSortButtons() {
    const sortByAmount = document.getElementById('generalExpenseSortByAmount');
    const sortByDate = document.getElementById('generalExpenseSortByDate');
    const sortByArticle = document.getElementById('generalExpenseSortByArticle');

    sortByAmount.textContent = 'Сортировать по сумме';
    sortByDate.textContent = 'Сортировать по дате';
    sortByArticle.textContent = 'Сортировать по статье';

    if (currentGeneralExpenseSortField === 'сумма') {
        sortByAmount.textContent = `Сумма ${currentGeneralExpenseSortDirection === 'desc' ? '▼' : '▲'}`;
    } else if (currentGeneralExpenseSortField === 'дата') {
        sortByDate.textContent = `Дата ${currentGeneralExpenseSortDirection === 'desc' ? '▼' : '▲'}`;
    } else if (currentGeneralExpenseSortField === 'статья') {
        sortByArticle.textContent = `Статья ${currentGeneralExpenseSortDirection === 'desc' ? '▼' : '▲'}`;
    }
}

function updateSalaryOfficeSortButtons() {
    const sortByAmount = document.getElementById('salaryOfficeSortByAmount');
    const sortByEmployee = document.getElementById('salaryOfficeSortByEmployee');
    const sortByPosition = document.getElementById('salaryOfficeSortByPosition');

    sortByAmount.textContent = 'Сортировать по зарплате';
    sortByEmployee.textContent = 'Сортировать по сотруднику';
    sortByPosition.textContent = 'Сортировать по должности';

    if (currentSalaryOfficeSortField === 'зарплата') {
        sortByAmount.textContent = `Зарплата ${currentSalaryOfficeSortDirection === 'desc' ? '▼' : '▲'}`;
    } else if (currentSalaryOfficeSortField === 'сотрудник') {
        sortByEmployee.textContent = `Сотрудник ${currentSalaryOfficeSortDirection === 'desc' ? '▼' : '▲'}`;
    } else if (currentSalaryOfficeSortField === 'должность') {
        sortByPosition.textContent = `Должность ${currentSalaryOfficeSortDirection === 'desc' ? '▼' : '▲'}`;
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function () {
    // Автоматически загружаем данные
    loadEmbeddedData();

    // Обновляем счетчик данных
    const totalRecords = (embeddedData.mainData?.length || 0) +
        (embeddedData.expensesData?.length || 0) +
        (embeddedData.salaryData?.length || 0);

    // Настраиваем модальные окна
    const modals = [
        'expensesModal',
        'indivisibleModal',
        'generalExpenseModal',
        'salaryOfficeModal'
    ];

    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        const closeBtn = modal.querySelector('.close');

        closeBtn.onclick = function () {
            modal.style.display = 'none';
        };

        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };
    });

    // Настраиваем обработчики для кнопок сортировки
    document.getElementById('sortByAmount').addEventListener('click', function () {
        changeSort('сумма');
    });
    document.getElementById('sortByDate').addEventListener('click', function () {
        changeSort('дата');
    });
    document.getElementById('sortByArticle').addEventListener('click', function () {
        changeSort('статья');
    });

    document.getElementById('indivisibleSortByAmount').addEventListener('click', function () {
        changeIndivisibleSort('сумма');
    });
    document.getElementById('indivisibleSortByDate').addEventListener('click', function () {
        changeIndivisibleSort('дата');
    });
    document.getElementById('indivisibleSortByArticle').addEventListener('click', function () {
        changeIndivisibleSort('статья');
    });

    document.getElementById('generalExpenseSortByAmount').addEventListener('click', function () {
        changeGeneralExpenseSort('сумма');
    });
    document.getElementById('generalExpenseSortByDate').addEventListener('click', function () {
        changeGeneralExpenseSort('дата');
    });
    document.getElementById('generalExpenseSortByArticle').addEventListener('click', function () {
        changeGeneralExpenseSort('статья');
    });

    document.getElementById('salaryOfficeSortByAmount').addEventListener('click', function () {
        changeSalaryOfficeSort('зарплата');
    });
    document.getElementById('salaryOfficeSortByEmployee').addEventListener('click', function () {
        changeSalaryOfficeSort('сотрудник');
    });
    document.getElementById('salaryOfficeSortByPosition').addEventListener('click', function () {
        changeSalaryOfficeSort('должность');
    });

    // Настраиваем обработчики для фильтров
    document.getElementById('dateFrom').addEventListener('change', applyFilters);
    document.getElementById('dateTo').addEventListener('change', applyFilters);
});